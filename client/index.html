<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/babel" >
        "use strict";
        
        let canvas;
        let ctx;
        let socket;
        let randColor;
        let mouseDown;
        let mouseX;
        let mouseY;
        let username;
        let score;
        let myWords = [];
        let drawStack = [];

        /*
        * 0 = Game Not Started/Picking Username
        * 1 = Not Your Turn
        * 2 = Your Turn
        * 3 = Waiting for players
        * 4 = Submitting Words
        * 5 = Correctly Guessed a Word
        */
        let gameState;

        let point = {
            x: 0,
            y: 0,
            lift: false,
            color: '#000000'
        };

        const makePoint = (isRelease) => {
            point.x = mouseX;
            point.y = mouseY;
            point.lift = isRelease,
            point.color = randColor;
            socket.emit('newpoint', point);
        };
        
        const draw = () => {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            let keys = Object.keys(drawStack);
            ctx.beginPath();
            ctx.lineWidth = 4;
            ctx.moveTo(drawStack[0].x, drawStack[0].y);
            for(let i=1; i < keys.length; i++){
                const drawCall = drawStack[keys[i]];
                ctx.strokeStyle = drawCall.color;
                if(drawStack[keys[i-1]].lift == true){
                    ctx.moveTo(drawCall.x, drawCall.y);
                }
                else{
                    ctx.lineTo(drawCall.x, drawCall.y);
                }
            }
            ctx.stroke();
        };
        
        const updateDrawstack = (data) => {
              drawStack.push(data);
              draw();
        };

        const checkMouse = () => {
            if(mouseDown && gameState == 2){
                makePoint(false);
            };
        };

        const sendMessage = (e) => {
            const message = document.querySelector("#message");
            const chat = document.querySelector("#chat");
            let chatMessage = message.value;
            message.value = '';
            if(!chatMessage){
              chatMessage = '...';
            }
            switch(gameState){
                case 0:
                    username = chatMessage;
                    socket.emit('userjoin', { msg: chatMessage});
                    break;
                case 1:
                    socket.emit('msgToServer', { msg : chatMessage, name: username});
                    break;
                case 4:
                    myWords.push(chatMessage);
                    if(myWords.length < 5){
                        document.querySelector('#chat').value += "You have " + (5-myWords.length) + " left to submit \r\n";
                    }
                    else{
                        socket.emit('addwords', {words: myWords, name: username});
                    }
                    
            }
        }
        
        const init = () => {
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext("2d");
            randColor = '#';
            mouseDown = false;
            gameState = 0;
            score = 0;
            var letters = '0123456789ABCDEF';
            var color = '#';
            for(var i = 0; i < 6; i++){
                randColor += letters[Math.floor(Math.random() * 16)];
            }
            
            point.color = randColor;
            
            canvas.addEventListener("mousedown", function(evt){
                mouseDown = true;
            });
            
            canvas.addEventListener("mouseup", function(evt){
                mouseDown = false;
                makePoint(true);
            });
            
            canvas.addEventListener("mousemove", function(evt){
                mouseX = evt.clientX;
                mouseY = evt.clientY;
            });
            
            const sendMsg = document.querySelector("#send");
            sendMsg.addEventListener('click', sendMessage);
            
            socket = io.connect();
            
            socket.on('catchUp', function(data){
                drawStack = data;
                gameState = 3;
                document.querySelector("#drawturn").innerHTML = "Waiting for Users...";
                draw();
            });
            
            socket.on('updateDraw', updateDrawstack);
            
            socket.on('msg', (data) => {
                if(!data.name){
                      document.querySelector('#chat').value += "" + data.msg + "\r\n";
                  }
                else{
                      document.querySelector('#chat').value += "" + data.name + ": " + data.msg + "\r\n";
                  }
            });
            
            socket.on('correctguess', (data) => {
                document.querySelector('#chat').value += "You guessed correctly! \r\n";
                score += 1;
                document.querySelector("#score").innerHTML = "Your Score: " + score;
                gameState = 5;
            });
            
            socket.on('joinedroom', function(data){
                gameState = 4;
                document.querySelector("#drawturn").innerHTML = "Please Submit Words";
            });
            
            socket.on('tickTimer', function(data){
                document.querySelector("#drawtimer").innerHTML = data;
            });
            
            socket.on('changeTurn', function(data) {
                if(gameState != 0 && gameState != 4){
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                    drawStack = [];
                    if(data.name == username){
                        document.querySelector("#drawturn").innerHTML = `Draw ${data.draw}`;
                        gameState = 2;
                    }
                    else{
                        document.querySelector("#drawturn").innerHTML = 'Guess The Picture';
                        gameState = 1;
                    }
                    document.querySelector("#drawtimer").innerHTML = "Time Left: 30";
                }
            });
            
            setInterval(checkMouse, 1);
            setInterval(function(){
                if(gameState == 2){
                    socket.emit('ticktimer');
                }
            }, 1000);
        };

        window.onload = init;
        
    </script>
</head>
<body>
    <canvas id="canvas" height="750" width="1000" style="border: 5px solid black" >Why are you not using HTML5?</canvas>
    <h1 id="drawturn">Enter Your Username in the Message Bar Then Hit Send</h1>
    <h2 id="drawtimer"></h2>
    <h3 id="score">Your Score: 0</h3>
    <div style="position: absolute; left: 1100px; top: 5px">
        <label for="message">Message:</label>
	    <input id="message" name="message" type="text"/>
	    <input id="send" type="button" value="send" />
	    <div style="padding: 5px">
            <textarea id="chat" rows="20" cols="40" readonly> </textarea>
        </div>
    </div>
</body>
</html>